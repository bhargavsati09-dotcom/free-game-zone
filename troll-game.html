<!DOCTYPE html>
<html>
<head>
  <title>Time Traveller Troll Game</title>
  <style>
    body { margin:0; overflow:hidden; background:black; color:white; font-family:Arial; }
    canvas { display:block; }
  </style>
</head>
<body>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

/* FULLSCREEN */
function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

/* GAME STATE */
let deaths = 0;
let firstDeath = false;
let laughTimer = 0;
let startTime = Date.now();

/* PLAYER */
let player = { x:120, y:0, w:30, h:40, vx:0, vy:0 };
const gravity = 0.7;
const jumpPower = -14;

function resetPlayer(){
  player.x = 120;
  player.y = canvas.height - 220;   // SAFE spawn (above first platform)
  player.vx = 0;
  player.vy = 0;
}
resetPlayer();

/* INPUT */
let keys = {};
addEventListener("keydown", e=>keys[e.key]=true);
addEventListener("keyup", e=>keys[e.key]=false);

/* ---------- WORLD STATE ---------- */

let basePlatform = {x:80, y:canvas.height-160, w:160, h:16, active:true};

let secretPlatform = {
  x:420,
  y:canvas.height-260,
  w:140,
  h:16,
  visible:false
};

/* killing star */
let star = {
  x:460,
  y:canvas.height-300,
  r:14
};

function resetWorld(){
  basePlatform.active = true;
  secretPlatform.visible = false;
}     
/* draw killing star */
ctx.fillStyle = "yellow";
ctx.beginPath();
for(let i=0;i<5;i++){
  let angle = i * (Math.PI * 2) / 5 - Math.PI/2;
  let x = star.x + Math.cos(angle) * star.r;
  let y = star.y + Math.sin(angle) * star.r;
  ctx.lineTo(x,y);

  angle += Math.PI/5;
  x = star.x + Math.cos(angle) * (star.r/2);
  y = star.y + Math.sin(angle) * (star.r/2);
  ctx.lineTo(x,y);
}
ctx.closePath();
ctx.fill();


/* MOVING LASER (SAFE HEIGHT) */
let laser = {
  x:200,
  y:canvas.height-120,
  w:180,
  h:6,
  dir:1
};


/* PORTAL */
let portal = {x:980, y:canvas.height-470, w:60, h:90};

/* COLLISION */
function hit(a,b){
  return a.x < b.x+b.w &&
         a.x+a.w > b.x &&
         a.y < b.y+b.h &&
         a.y+a.h > b.y;
}

function onGround(){
  let test = {...player, y:player.y+1};
  return [...platforms, secretPlatform]
    .filter(p=>p.visible!==false)
    .some(p=>hit(test,p));
}

/* DIE */
function die(){
  deaths++;
  laughTimer = 50;
  firstDeath = true;

  resetWorld();   // VERY IMPORTANT
  resetPlayer();
}

/* UPDATE */
function update(){

  player.vx = 0;
  if(keys["ArrowLeft"]) player.vx = -5;
  if(keys["ArrowRight"]) player.vx = 5;
  if(keys["ArrowUp"] && onGround()) player.vy = jumpPower;

  player.vy += gravity;
  player.y += player.vy;

  /* stand on base platform */
  if(basePlatform.active && hit(player, basePlatform) && player.vy >= 0){
    player.y = basePlatform.y - player.h;
    player.vy = 0;
  }

  /* MAGIC TRIGGER */
  if(basePlatform.active && player.x > basePlatform.x + 80){
    basePlatform.active = false;
    secretPlatform.visible = true;
  }

  /* stand on secret platform */
  if(secretPlatform.visible && hit(player, secretPlatform) && player.vy >= 0){
    player.y = secretPlatform.y - player.h;
    player.vy = 0;
  }

  /* STAR KILL */
  let dx = (player.x + player.w/2) - star.x;
  let dy = (player.y + player.h/2) - star.y;
  if(Math.sqrt(dx*dx + dy*dy) < star.r + 10){
    die();
  }

  /* fall */
  if(player.y > canvas.height) die();

  if(laughTimer>0) laughTimer--;
}


  /* movement */
  player.vx = 0;
  if(keys["ArrowLeft"]) player.vx = -5;
  if(keys["ArrowRight"]) player.vx = 5;
  if(keys["ArrowUp"] && onGround()) player.vy = jumpPower;

  player.vy += gravity;

  /* horizontal */
  player.x += player.vx;
  [...platforms, secretPlatform].forEach(p=>{
    if(p.visible===false) return;
    if(hit(player,p)){
      if(player.vx>0) player.x = p.x-player.w;
      if(player.vx<0) player.x = p.x+p.w;
    }
  });

  /* vertical */
  player.y += player.vy;
  [...platforms, secretPlatform].forEach(p=>{
    if(p.visible===false) return;
    if(hit(player,p)){
      if(player.vy>0){ player.y = p.y-player.h; player.vy=0; }
      if(player.vy<0){ player.y = p.y+p.h; player.vy=0; }
    }
  });

  /* SECRET PLATFORM APPEAR */
  if(!secretPlatform.visible && player.x > 700){
    secretPlatform.visible = true;
  }

  /* MOVING LASER */
  laser.x += 3 * laser.dir;
  if(laser.x < 150 || laser.x > 500) laser.dir *= -1;

  if(hit(player, laser)) die();

  /* STAR KILL */
  stars.forEach(s=>{
    let dx = player.x+15 - s.x;
    let dy = player.y+20 - s.y;
    if(Math.sqrt(dx*dx + dy*dy) < s.r + 10) die();
  });

  /* FALL */
  if(player.y > canvas.height) die();

  /* PORTAL WIN */
  if(hit(player, portal)){
    alert("YOU ESCAPED ðŸ˜ˆ");
    location.reload();
  }

  if(laughTimer>0) laughTimer--;
}

/* DRAW FACE */
function drawFace(){
  let x = canvas.width - 180;
  let y = 120;
  let laughing = laughTimer > 0;

  ctx.strokeStyle = "red";
  ctx.lineWidth = 3;

  /* eyes */
  if(laughing){
    ctx.beginPath();
    ctx.moveTo(x-30,y); ctx.lineTo(x-10,y-5);
    ctx.moveTo(x+10,y-5); ctx.lineTo(x+30,y);
    ctx.stroke();
  }else{
    ctx.strokeRect(x-30,y-10,20,10);
    ctx.strokeRect(x+10,y-10,20,10);
  }

  /* mouth */
  ctx.beginPath();
  ctx.arc(x,y+20,20,laughing?0:Math.PI,laughing?Math.PI:0);
  ctx.stroke();

  ctx.fillStyle="white";
  ctx.font="18px Arial";

  if(!firstDeath){
    ctx.fillText("Just a simple space person game", x-140, y+60);
  } else if(deaths === 1){
    ctx.fillText("Nah, it is not that much simple but you can do it", x-200, y+60);
  }
}

/* DRAW */
function draw(){

  ctx.clearRect(0,0,canvas.width,canvas.height);

  /* platforms */
  ctx.fillStyle="#00d4ff";
  platforms.forEach(p=>ctx.fillRect(p.x,p.y,p.w,p.h));

  if(secretPlatform.visible){
    ctx.fillStyle="#c77dff";   // light purple âœ”
    ctx.fillRect(secretPlatform.x,secretPlatform.y,secretPlatform.w,secretPlatform.h);
  }

  /* laser */
  ctx.fillStyle="red";
  ctx.fillRect(laser.x, laser.y, laser.w, laser.h);

  /* stars */
  ctx.fillStyle="yellow";
  stars.forEach(s=>{
    ctx.beginPath();
    ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
    ctx.fill();
  });

  /* portal */
  ctx.fillStyle="violet";
  ctx.fillRect(portal.x, portal.y, portal.w, portal.h);

  /* player */
  /* robe body */
ctx.fillStyle = "#5f0f40";
ctx.fillRect(player.x, player.y+8, player.w, player.h-8);

/* glowing head */
ctx.fillStyle = "#ffd166";
ctx.beginPath();
ctx.arc(player.x + player.w/2, player.y+6, 6, 0, Math.PI*2);
ctx.fill();

/* eye visor */
ctx.strokeStyle = "cyan";
ctx.beginPath();
ctx.moveTo(player.x+6, player.y+6);
ctx.lineTo(player.x+player.w-6, player.y+6);
ctx.stroke();

  /* UI */
  ctx.fillStyle="white";
  ctx.fillText("Deaths: "+deaths, 20,30);
  ctx.fillText("Time: "+((Date.now()-startTime)/1000).toFixed(1), 20,55);
}

/* LOOP */
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
