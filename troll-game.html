<!DOCTYPE html>
<html>
<head>
  <title>Time Traveller Troll Game</title>
  <style>
    body { margin:0; overflow:hidden; background:black; color:white; font-family:Arial; }
    #ui { position:fixed; top:10px; left:10px; font-size:18px; }
    canvas { display:block; }
  </style>
</head>
<body>

<div id="ui">
Level: <span id="level">1</span> |
Deaths: <span id="deaths">0</span> |
Time: <span id="time">0.0</span>s
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

/* ---------- GAME STATE ---------- */
let level = 1;
let deaths = 0;
let startTime = Date.now();
let win = false;

let player = { x: 80, y: 0, w: 24, h: 30, vy: 0, onGround: false };

const gravity = 0.7;
const jumpPower = -15;

let keys = {};
document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

function resetPlayer(){
  player.x = 80;
  player.y = canvas.height - 120;
  player.vy = 0;
}

/* ---------- LEVEL 1 DESIGN (FIXED) ---------- */
function getLevel(){
  return {
    platforms: [
      {x:50,  y:canvas.height-140, w:120, h:12},
      {x:220, y:canvas.height-220, w:120, h:12},
      {x:390, y:canvas.height-300, w:120, h:12},
      {x:560, y:canvas.height-380, w:120, h:12},
      {x:740, y:canvas.height-460, w:120, h:12}
    ],
    portal: {x:900, y:canvas.height-520, w:40, h:60}
  };
}

let current = getLevel();
resetPlayer();

/* ---------- STARS ---------- */
let stars = [];
for(let i=0;i<150;i++){
  stars.push({ x:Math.random()*2000, y:Math.random()*canvas.height, r:Math.random()*2 });
}

/* ---------- UPDATE ---------- */
function update(){
  if(win) return;

  if(keys["ArrowLeft"]) player.x -= 5;
  if(keys["ArrowRight"]) player.x += 5;

  if(keys["ArrowUp"] && player.onGround){
    player.vy = jumpPower;
    player.onGround = false;
  }

  player.vy += gravity;
  player.y += player.vy;
  player.onGround = false;

  /* Platform collision */
  current.platforms.forEach(p=>{
    if(
      player.x < p.x + p.w &&
      player.x + player.w > p.x &&
      player.y < p.y + p.h &&
      player.y + player.h > p.y &&
      player.vy >= 0
    ){
      player.y = p.y - player.h;
      player.vy = 0;
      player.onGround = true;
    }
  });

  /* BLACK HOLE FLOOR (death if fall) */
  if(player.y > canvas.height){
    die();
  }

  /* Portal */
  let g = current.portal;
  if(
    player.x < g.x + g.w &&
    player.x + player.w > g.x &&
    player.y < g.y + g.h &&
    player.y + player.h > g.y
  ){
    win = true;
  }

  /* Timer */
  document.getElementById("time").textContent =
    ((Date.now()-startTime)/1000).toFixed(1);
}

function die(){
  deaths++;
  document.getElementById("deaths").textContent = deaths;

  if(deaths > 30){
    deaths = 0;
    level = 1;
    startTime = Date.now();
  }

  resetPlayer();
}

/* ---------- DRAW PLAYER ---------- */
function drawPlayer(){
  let x = player.x, y = player.y;

  ctx.fillStyle="#ffd166"; ctx.fillRect(x+6,y,12,12);      // head
  ctx.fillStyle="#06d6a0"; ctx.fillRect(x+4,y+12,16,12);   // body
  ctx.fillStyle="#118ab2"; ctx.fillRect(x+4,y+24,6,6);     // leg
  ctx.fillRect(x+14,y+24,6,6);
  ctx.fillStyle="#ef476f"; ctx.fillRect(x-4,y+12,6,10);    // backpack
}

/* ---------- DRAW ---------- */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  /* stars */
  ctx.fillStyle="white";
  stars.forEach(s=>ctx.fillRect(s.x-player.x*0.2, s.y, s.r, s.r));

  /* black hole floor glow */
  let grad = ctx.createLinearGradient(0,canvas.height-80,0,canvas.height);
  grad.addColorStop(0,"#220044");
  grad.addColorStop(1,"black");
  ctx.fillStyle = grad;
  ctx.fillRect(0,canvas.height-80,canvas.width,80);

  /* platforms */
  ctx.fillStyle="#00d4ff";
  current.platforms.forEach(p=>ctx.fillRect(p.x,p.y,p.w,p.h));

  /* portal */
  ctx.fillStyle="purple";
  let g=current.portal;
  ctx.fillRect(g.x,g.y,g.w,g.h);

  drawPlayer();

  if(win){
    ctx.fillStyle="white";
    ctx.font="40px Arial";
    ctx.fillText("LEVEL COMPLETE ‚è≥", canvas.width/2-180, canvas.height/2);
  }
}

/* ---------- LOOP ---------- */
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
