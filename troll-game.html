<!DOCTYPE html>
<html>
<head>
  <title>Time Traveller Troll Game</title>
  <style>
    body { margin:0; overflow:hidden; background:black; color:white; font-family:Arial; }
    #ui { position:fixed; top:10px; left:10px; font-size:18px; }
    canvas { display:block; }
  </style>
</head>
<body>

<div id="ui">
Level: <span id="level">1</span> |
Deaths: <span id="deaths">0</span> |
Time: <span id="time">0.0</span>s
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

/* ---------- STATE ---------- */
let deaths = 0;
let startTime = Date.now();
let win = false;

let player = { x: 120, y: 0, w: 24, h: 30, vy: 0, onGround: false };

const gravity = 0.7;
const jumpPower = -15;

let keys = {};
document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

function resetPlayer(){
  player.x = 120;
  player.y = canvas.height - 180;
  player.vy = 0;
}

/* ---------- LEVEL ---------- */
let platforms = [
  {x:80,  y:canvas.height-150, w:140, h:12},
  {x:260, y:canvas.height-230, w:120, h:12},
  {x:420, y:canvas.height-300, w:120, h:12, fake:true},
  {x:600, y:canvas.height-360, w:120, h:12},
  {x:780, y:canvas.height-430, w:120, h:12}
];

let portal = {x:950, y:canvas.height-500, w:40, h:60};

/* ---------- TRAPS ---------- */
let laser = { x:300, y:canvas.height-260, w:120, h:4, dir:1 };

let stars = [
  {x:500, y:canvas.height-320, r:10},
  {x:720, y:canvas.height-390, r:10}
];

let randomPlatform = {x:520, y:canvas.height-260, w:100, h:12, active:false};

resetPlayer();

/* ---------- UPDATE ---------- */
function update(){
  if(win) return;

  if(keys["ArrowLeft"]) player.x -= 5;
  if(keys["ArrowRight"]) player.x += 5;

  if(keys["ArrowUp"] && player.onGround){
    player.vy = jumpPower;
    player.onGround = false;
  }

  player.vy += gravity;
  player.y += player.vy;
  player.onGround = false;

  /* ONE-WAY platform collision */
  [...platforms, ...(randomPlatform.active ? [randomPlatform] : [])].forEach(p=>{
    if(p.fake && player.x > p.x && player.x < p.x+p.w) return;

    if(
      player.x < p.x+p.w &&
      player.x+player.w > p.x &&
      player.y+player.h <= p.y + player.vy &&
      player.y+player.h >= p.y &&
      player.vy >= 0
    ){
      player.y = p.y-player.h;
      player.vy = 0;
      player.onGround = true;
    }
  });

  /* Random platform trigger */
  if(player.x > 400) randomPlatform.active = true;

  /* Moving laser */
  laser.x += laser.dir * 2;
  if(laser.x < 260 || laser.x > 420) laser.dir *= -1;

  if(rectHit(player, laser)) die();

  /* Star collision */
  stars.forEach(s=>{
    let dx = player.x+12 - s.x;
    let dy = player.y+15 - s.y;
    if(Math.sqrt(dx*dx+dy*dy) < s.r+10) die();
  });

  /* Fall death */
  if(player.y > canvas.height) die();

  /* Portal */
  if(rectHit(player, portal)) win = true;

  document.getElementById("time").textContent =
    ((Date.now()-startTime)/1000).toFixed(1);
}

function die(){
  deaths++;
  document.getElementById("deaths").textContent = deaths;

  randomPlatform.active = false; // FIXED BUG

  resetPlayer();
}

function rectHit(a,b){
  return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y;
}

/* ---------- DRAW STAR SHAPE ---------- */
function drawStar(x,y,r){
  ctx.beginPath();
  for(let i=0;i<5;i++){
    ctx.lineTo(
      x + r*Math.cos((18+i*72)*Math.PI/180),
      y - r*Math.sin((18+i*72)*Math.PI/180)
    );
    ctx.lineTo(
      x + (r/2)*Math.cos((54+i*72)*Math.PI/180),
      y - (r/2)*Math.sin((54+i*72)*Math.PI/180)
    );
  }
  ctx.closePath();
  ctx.fillStyle="orange";
  ctx.shadowColor="red";
  ctx.shadowBlur=15;
  ctx.fill();
  ctx.shadowBlur=0;
}

/* ---------- DRAW PLAYER ---------- */
function drawPlayer(){
  let x=player.x, y=player.y;
  ctx.fillStyle="#ffd166"; ctx.fillRect(x+6,y,12,12);
  ctx.fillStyle="#06d6a0"; ctx.fillRect(x+4,y+12,16,12);
  ctx.fillStyle="#118ab2"; ctx.fillRect(x+4,y+24,6,6);
  ctx.fillRect(x+14,y+24,6,6);
  ctx.fillStyle="#ef476f"; ctx.fillRect(x-4,y+12,6,10);
}

/* ---------- DRAW ---------- */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  /* black hole floor */
  let grad = ctx.createLinearGradient(0,canvas.height-80,0,canvas.height);
  grad.addColorStop(0,"#220044");
  grad.addColorStop(1,"black");
  ctx.fillStyle=grad;
  ctx.fillRect(0,canvas.height-80,canvas.width,80);

  /* platforms */
  ctx.fillStyle="#00d4ff";
  platforms.forEach(p=>{
    if(p.fake && player.x>p.x && player.x<p.x+p.w) return;
    ctx.fillRect(p.x,p.y,p.w,p.h);
  });

  /* random hidden platform */
  if(randomPlatform.active){
    ctx.fillStyle="rgba(180,0,255,0.3)";
    ctx.fillRect(randomPlatform.x,randomPlatform.y,randomPlatform.w,randomPlatform.h);
  }

  /* laser */
  ctx.fillStyle="red";
  ctx.fillRect(laser.x,laser.y,laser.w,laser.h);

  /* deadly stars */
  stars.forEach(s=>drawStar(s.x,s.y,s.r));

  /* portal */
  ctx.fillStyle="purple";
  ctx.fillRect(portal.x,portal.y,portal.w,portal.h);

  drawPlayer();

  if(win){
    ctx.fillStyle="white";
    ctx.font="40px Arial";
    ctx.fillText("LEVEL COMPLETE ðŸ˜ˆ", canvas.width/2-170, canvas.height/2);
  }
}

function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>




</body>
</html>
